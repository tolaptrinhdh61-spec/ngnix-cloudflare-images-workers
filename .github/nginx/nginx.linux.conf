# =========================
# NGINX (Linux/Ubuntu) - Repo-local runtime
# Proxy Load Balancer -> Cloudflare Workers (HTTPS)
# Run with: nginx -p "$PWD/nginx" -c nginx.conf -g "daemon off;"
# =========================

worker_processes auto;
worker_rlimit_nofile 65535;

error_log  logs/nginx-error.log warn;
pid        run/nginx.pid;

events {
    worker_connections 4096;
    multi_accept on;
    use epoll;
}

http {
    # Kh√¥ng ph·ª• thu·ªôc mime.types ƒë·ªÉ tr√°nh l·ªói thi·∫øu file khi ch·∫°y trong repo
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'upstream: $upstream_addr';

    access_log logs/nginx-access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    keepalive_timeout 65;
    keepalive_requests 1000;

    client_body_buffer_size 128k;
    client_max_body_size 100m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;

    client_body_timeout 12;
    client_header_timeout 12;
    send_timeout 10;

    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_comp_level 5;
    gzip_types text/plain text/css text/xml application/json application/javascript image/svg+xml;

    # ‚úÖ Repo-local temp folders (n·∫øu kh√¥ng c√≥ s·∫Ω g√¢y [emerg] l√∫c start)
    client_body_temp_path temp/client_body 1 2;
    proxy_temp_path       temp/proxy       1 2;
    fastcgi_temp_path     temp/fastcgi     1 2;
    uwsgi_temp_path       temp/uwsgi       1 2;
    scgi_temp_path        temp/scgi        1 2;

    # ‚úÖ Tr√°nh l·ªói map_hash tr√™n m√¥i tr∆∞·ªùng kh√°c nhau
    map_hash_bucket_size 128;
    map_hash_max_size 2048;

    # ‚úÖ B·∫ÆT BU·ªòC khi proxy_pass d√πng bi·∫øn (https://$backend)
    resolver 1.1.1.1 8.8.8.8 valid=300s ipv6=off;
    resolver_timeout 5s;

    # ‚úÖ X-Forwarded-Proto: n·∫øu cloudflared c√≥ g·ª≠i th√¨ gi·ªØ, kh√¥ng th√¨ d√πng $scheme
    map $http_x_forwarded_proto $xfp {
        default $http_x_forwarded_proto;
        ""      $scheme;
    }

    # ‚úÖ Chia traffic (g·∫ßn nh∆∞ round-robin theo request)
    # üì¢‚ûïKhi th√™m m·ªõi ph·∫£i chia t·∫£i r·ªông l·∫°i‚ûï
    split_clients "${remote_addr}${request_uri}${msec}" $backend {
        25%  images-worker.o23bsr0618.workers.dev;
        25%  image-api-multi-d1.ongtrieuhau861.workers.dev;
        25%  images-worker.o23bsr0636.workers.dev;
        *    images-worker.ongtrieuhau11028.workers.dev;
    }

    # ‚úÖ Backend d·ª± ph√≤ng (ƒë·ªïi ch√©o)
    # üì¢‚ûïKhi th√™m m·ªõi ph·∫£i chia t·∫£i r·ªông l·∫°i‚ûï
    map $backend $backend_fallback {
        default images-worker.o23bsr0636.workers.dev;

        images-worker.o23bsr0618.workers.dev          image-api-multi-d1.ongtrieuhau861.workers.dev;
        image-api-multi-d1.ongtrieuhau861.workers.dev images-worker.o23bsr0636.workers.dev;
        images-worker.o23bsr0636.workers.dev          images-worker.ongtrieuhau11028.workers.dev;
        images-worker.ongtrieuhau11028.workers.dev    images-worker.o23bsr0618.workers.dev;
    }

    server {
        listen 0.0.0.0:8080;
        server_name _;

        access_log logs/loadbalancer-access.log main;
        error_log  logs/loadbalancer-error.log;

        location / {
            proxy_intercept_errors on;

            # ‚úÖ g·ªçi worker theo hostname th·∫≠t (SNI/Host ƒë√∫ng)
            proxy_pass https://$backend;

            proxy_ssl_server_name on;
            proxy_ssl_name $backend;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;

            # ‚ö†Ô∏è N·∫øu Ubuntu c√≥ CA ƒë·∫ßy ƒë·ªß, b·∫°n c√≥ th·ªÉ b·∫≠t verify ON.
            # ƒê·ªÉ pipeline ‚Äúch·∫°y li·ªÅn kh√¥ng l·ªói‚Äù, t·∫°m ƒë·ªÉ off gi·ªëng b·∫£n Windows.
            proxy_ssl_verify off;

            proxy_set_header Host $backend;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $xfp;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # Buffering v·ª´a ph·∫£i (Linux ·ªïn)
            proxy_buffering on;
            proxy_buffer_size 16k;
            proxy_buffers 16 16k;

            error_page 502 503 504 = @fallback;
        }

        location @fallback {
            proxy_pass https://$backend_fallback;

            proxy_ssl_server_name on;
            proxy_ssl_name $backend_fallback;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            proxy_ssl_verify off;

            proxy_set_header Host $backend_fallback;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $xfp;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        location /nginx-health {
            access_log off;
            add_header Content-Type text/plain;
            return 200 "Nginx Load Balancer OK\n";
        }

        location = /50x.html {
            add_header Content-Type text/plain;
            return 502 "Backend servers unavailable\n";
        }

        error_page 502 503 504 /50x.html;
    }
}
